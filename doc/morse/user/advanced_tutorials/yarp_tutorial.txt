====== YARP-based simulation tutorial ======

===== Setup =====

You need to install YARP and its Python bindings, by following the [[morse:user:installation#YARP | instructions]] in the installation page.

Before running a simulation using YARP, it is necessary to open a new shell terminal and start the ''yarpserver'' program:
  $ yarpserver

===== Configuring the scenario =====

You must link a YARP middleware object into the MORSE scenario file
Create the bindings of the components with yarp, by editing the file ''component_config.py'' inside the Blender file.


==== Link a Camera sensor ====

  - With the mouse over the 3D view in Blender, press <key>S-F1</key> to open the Load Library browser
  - Navigate to the directory ''$ORS_ROOT/data/morse/components/sensors''
  - Press :LMB: over the file ''morse_camera.blend''
  - Press :LMB: over the item ''Object''
  - Toggle the buttons **Relative Paths** and **Link** at the bottom of the window
  - Press :RMB: over the items ''CameraMain'', ''CameraUser'', ''CameraCube'', ''CameraLens''
  - Press the button **Load Library**. You'll return to the 3D View
  - Select the newly inserted ''CameraMain'' object in the scene, either by :RMB: clicking over the object in the 3D View, or :LMB: over the object's name in the Outliner window. The object will be highlighted in cyan colour, and can not be moved around.
  - Select the child object, by pressing <key>S-g</key>, then hitting <key>enter</key>
  - Convert the object to local, by pressing <key>l</key> then hitting <key>enter</key>
  - Switch to front view by pressing <key>'1 NumPad'</key>
  - Press <key>g</key>, then move the ''CameraMain'' object to the correct location with respect to the robot
  - Press :LMB: to accept the movement
  - With the ''CameraMain'' object selected, hold down <key>S</key> and then :RMB: over the robot object
  - Press <key>C-p</key> and then hit <key>enter</key> make the robot the parent of the controller

==== Insert the middleware object ====
  - With the mouse over the 3D view in Blender, press <key>S-F1</key> to open the Load Library browser
  - Navigate to the directory ''$ORS_ROOT/data/morse/components/middleware''
  - Press :LMB: over the file ''yarp_empty.blend''
  - Press :LMB: over the item ''Object''
  - Toggle the buttons **Relative Paths** and **Link** at the bottom of the window
  - Press :RMB: over the item ''Yarp_Empty''
  - Press the button **Load Library**. You'll return to the 3D View
  - It is not necessary to make this object local or to move it. But it can be useful to avoid cluttering of items in the scene 

__Note__: One single middleware Empty is necessary to enable the middleware, regardless of how many components will make use of it.

==== Configuring the middlewares ====
Binding the components in the scene with the middleware is done in a configuration file within the Blender file.

  - On the **Text Editor** window, select the file ''component_config.py''
  - Add the following items to the ''component_mw'' dictionary:
 
<code python>
component_mw = {
    "CameraMain": ["Yarp", "post_image_RGBA"],
    "GPS": ["Yarp", "post_message"],
    "Motion_Controller": ["Yarp", "read_message"],
	}
</code>


===== Reading/writing data =====

When the simulation starts, it will print the names of the YARP ports that have been created for every corresponding component. These port names can be used to connect to the component from an external program or client.

The simplest method to test the reading and writing of data is by using the terminal clients. For example, to read the GPS data of the robot through a port named ''/ors/robots/OBATRV/OBGPS/out'', you can type the following in a terminal:
  $ yarp read /data/in /ors/robots/OBATRV/OBGPS/out

To enter speed commands through a port named ''/ors/robots/OBATRV/OBMotion_Controller/in'', use the command
  $ yarp write /data/out /ors/robots/OBATRV/OBMotion_Controller/in
Then type the three destination coordinates, separated by spaces, and press <key>enter</key>

To view the images of the camera though a port ''/ors/robots/OBATRV/OBCameraMain/out'':
  $ yarpview /img/read &
  $ yarp connect /ors/robots/OBATRV/OBCameraMain/out /img/read
